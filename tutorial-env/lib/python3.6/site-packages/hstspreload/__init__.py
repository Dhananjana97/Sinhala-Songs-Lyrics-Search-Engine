"""Check if a host is in the Google Chrome HSTS Preload list"""

import functools
import os
import typing

__version__ = "2020.6.23"
__checksum__ = "0b6dac0f713794a4861a09be69e3342c06ca2b7acbf911f0f8dff3cb8ac99349"
__all__ = ["in_hsts_preload"]

# fmt: off
_GTLD_INCLUDE_SUBDOMAINS = {b'android', b'app', b'bank', b'chrome', b'dev', b'foo', b'gle', b'gmail', b'google', b'hangout', b'insurance', b'meet', b'new', b'page', b'play', b'search', b'youtube'}  # noqa: E501
_JUMPTABLE = [[(0, 11), (11, 5), None, (16, 57), (73, 26), (99, 12), None, (111, 19), (130, 11), (141, 7), (148, 20), (168, 18), None, (186, 22), (208, 45), (253, 7), (260, 9), (269, 36), (305, 10), (315, 10), (325, 21), None, (346, 50), (396, 8), (404, 9), (413, 11), (424, 13), (437, 14), (451, 14), None, None, (465, 29), (494, 16), (510, 35), (545, 14), (559, 24), (583, 9), None, (592, 17), (609, 20), (629, 8), (637, 13), (650, 10), None, (660, 11), (671, 6), (677, 26), (703, 5), (708, 5), (713, 10), (723, 10), (733, 11), (744, 12), (756, 27), None, (783, 11), (794, 11), (805, 7), (812, 29), (841, 18), (859, 27), (886, 46), (932, 25), (957, 16), (973, 8), (981, 5), (986, 22), (1008, 18), None, (1026, 36), (1062, 15), (1077, 8), (1085, 5), None, (1090, 5), (1095, 16), (1111, 14), (1125, 18), None, (1143, 14), (1157, 18), (1175, 48), (1223, 19), (1242, 5), (1247, 46), (1293, 14), (1307, 14), (1321, 20), None, (1341, 6), (1347, 13), (1360, 10), (1370, 19), None, (1389, 13), (1402, 19), (1421, 5), (1426, 4), (1430, 22), (1452, 10), (1462, 7), (1469, 14), (1483, 21), (1504, 11), (1515, 10), (1525, 12), (1537, 32), None, (1569, 10), (1579, 14), (1593, 12), (1605, 45), (1650, 15), None, (1665, 11), (1676, 23), (1699, 21), (1720, 26), (1746, 6), (1752, 6), (1758, 7), (1765, 5), (1770, 20), (1790, 23), (1813, 24), (1837, 13), (1850, 15), (1865, 19), (1884, 6), (1890, 61), (1951, 44), (1995, 12), (2007, 23), (2030, 16), (2046, 38), (2084, 6), (2090, 12), (2102, 44), (2146, 6), (2152, 41), (2193, 13), (2206, 23), (2229, 30), (2259, 16), (2275, 8), (2283, 6), (2289, 12), (2301, 19), (2320, 21), (2341, 15), None, (2356, 35), (2391, 21), (2412, 17), (2429, 19), (2448, 26), (2474, 5), (2479, 37), (2516, 30), (2546, 16), (2562, 10), (2572, 17), (2589, 23), (2612, 14), (2626, 17), (2643, 8), (2651, 4), (2655, 7), (2662, 29), (2691, 6), (2697, 18), (2715, 27), (2742, 20), (2762, 17), (2779, 19), (2798, 12), (2810, 40), (2850, 40), (2890, 12), (2902, 48), (2950, 25), (2975, 12), None, (2987, 8), (2995, 20), (3015, 12), (3027, 6), (3033, 23), None, (3056, 23), (3079, 33), (3112, 14), (3126, 12), (3138, 27), None, (3165, 26), (3191, 31), (3222, 50), (3272, 15), (3287, 20), (3307, 15), (3322, 21), (3343, 32), (3375, 24), (3399, 20), (3419, 13), (3432, 60), (3492, 19), (3511, 9), (3520, 12), (3532, 12), (3544, 11), (3555, 10), (3565, 48), (3613, 32), None, (3645, 25), (3670, 12), None, (3682, 8), (3690, 8), (3698, 7), None, (3705, 25), (3730, 17), None, (3747, 21), (3768, 35), (3803, 12), (3815, 10), (3825, 36), (3861, 20), (3881, 22), (3903, 23), (3926, 19), (3945, 12), (3957, 5), (3962, 30), (3992, 24), (4016, 14), (4030, 14), (4044, 47), (4091, 38), None, None, (4129, 51), (4180, 42), None, (4222, 14), None, (4236, 15), (4251, 8), (4259, 21), (4280, 6), (4286, 16), (4302, 17)], [(4319, 5999), (10318, 6448), (16766, 6852), (23618, 5562), (29180, 6104), (35284, 5674), (40958, 6597), (47555, 5836), (53391, 6503), (59894, 5875), (65769, 6837), (72606, 6101), (78707, 6549), (85256, 6915), (92171, 6393), (98564, 6303), (104867, 6809), (111676, 5827), (117503, 6047), (123550, 6404), (129954, 6648), (136602, 6324), (142926, 6599), (149525, 5868), (155393, 6035), (161428, 6444), (167872, 6378), (174250, 6642), (180892, 6088), (186980, 6240), (193220, 6580), (199800, 6299), (206099, 6225), (212324, 6787), (219111, 5883), (224994, 6648), (231642, 5996), (237638, 6720), (244358, 6435), (250793, 6810), (257603, 7154), (264757, 6061), (270818, 6154), (276972, 5898), (282870, 5900), (288770, 5746), (294516, 6073), (300589, 6747), (307336, 6159), (313495, 5485), (318980, 6227), (325207, 6368), (331575, 6328), (337903, 6537), (344440, 6598), (351038, 6586), (357624, 6569), (364193, 5589), (369782, 6564), (376346, 5612), (381958, 6307), (388265, 6082), (394347, 6127), (400474, 6546), (407020, 6407), (413427, 6366), (419793, 5783), (425576, 6737), (432313, 6457), (438770, 6614), (445384, 6259), (451643, 6241), (457884, 5527), (463411, 6800), (470211, 6740), (476951, 6694), (483645, 5858), (489503, 6939), (496442, 6876), (503318, 5850), (509168, 6485), (515653, 5508), (521161, 6093), (527254, 6338), (533592, 6277), (539869, 6247), (546116, 6429), (552545, 6442), (558987, 6520), (565507, 6217), (571724, 6977), (578701, 5892), (584593, 5970), (590563, 6388), (596951, 6282), (603233, 6747), (609980, 6572), (616552, 6203), (622755, 6079), (628834, 5949), (634783, 5884), (640667, 6579), (647246, 6004), (653250, 6100), (659350, 5877), (665227, 6564), (671791, 6177), (677968, 6636), (684604, 7832), (692436, 6756), (699192, 6679), (705871, 6187), (712058, 6066), (718124, 6464), (724588, 6717), (731305, 6312), (737617, 6043), (743660, 6236), (749896, 6241), (756137, 6682), (762819, 6615), (769434, 6543), (775977, 6877), (782854, 6490), (789344, 7613), (796957, 6187), (803144, 5491), (808635, 6699), (815334, 6437), (821771, 7760), (829531, 6693), (836224, 6018), (842242, 6483), (848725, 6644), (855369, 6103), (861472, 6589), (868061, 5785), (873846, 6558), (880404, 6187), (886591, 6301), (892892, 6251), (899143, 6862), (906005, 6070), (912075, 6037), (918112, 6354), (924466, 6331), (930797, 6218), (937015, 6627), (943642, 5898), (949540, 6806), (956346, 6358), (962704, 6462), (969166, 6537), (975703, 6246), (981949, 6307), (988256, 6192), (994448, 6209), (1000657, 6175), (1006832, 5988), (1012820, 5592), (1018412, 5872), (1024284, 6353), (1030637, 6951), (1037588, 5910), (1043498, 6330), (1049828, 6725), (1056553, 6153), (1062706, 5933), (1068639, 6581), (1075220, 6358), (1081578, 5681), (1087259, 6383), (1093642, 7362), (1101004, 5800), (1106804, 5997), (1112801, 6442), (1119243, 6063), (1125306, 6399), (1131705, 6053), (1137758, 5832), (1143590, 7062), (1150652, 6520), (1157172, 6217), (1163389, 6619), (1170008, 7022), (1177030, 7035), (1184065, 5997), (1190062, 6776), (1196838, 6030), (1202868, 6439), (1209307, 6505), (1215812, 5931), (1221743, 6608), (1228351, 6683), (1235034, 6432), (1241466, 6192), (1247658, 6098), (1253756, 6185), (1259941, 6538), (1266479, 5933), (1272412, 6346), (1278758, 5756), (1284514, 6851), (1291365, 6744), (1298109, 6485), (1304594, 6611), (1311205, 5524), (1316729, 6508), (1323237, 6285), (1329522, 6429), (1335951, 6592), (1342543, 6828), (1349371, 6282), (1355653, 6337), (1361990, 6491), (1368481, 6241), (1374722, 6257), (1380979, 6349), (1387328, 6427), (1393755, 6057), (1399812, 6283), (1406095, 5759), (1411854, 6930), (1418784, 6467), (1425251, 6059), (1431310, 6553), (1437863, 6384), (1444247, 5548), (1449795, 6382), (1456177, 6279), (1462456, 7249), (1469705, 6181), (1475886, 5718), (1481604, 6812), (1488416, 6138), (1494554, 6743), (1501297, 5868), (1507165, 5939), (1513104, 5687), (1518791, 6498), (1525289, 6252), (1531541, 6642), (1538183, 6044), (1544227, 6387), (1550614, 6177), (1556791, 6819), (1563610, 6212), (1569822, 5609), (1575431, 6302), (1581733, 6048), (1587781, 6453), (1594234, 6601), (1600835, 6943), (1607778, 6040), (1613818, 6074), (1619892, 6522)], [(1626414, 703), (1627117, 605), (1627722, 628), (1628350, 645), (1628995, 491), (1629486, 579), (1630065, 665), (1630730, 808), (1631538, 652), (1632190, 627), (1632817, 509), (1633326, 508), (1633834, 741), (1634575, 888), (1635463, 919), (1636382, 690), (1637072, 1188), (1638260, 574), (1638834, 804), (1639638, 640), (1640278, 713), (1640991, 688), (1641679, 787), (1642466, 709), (1643175, 684), (1643859, 631), (1644490, 910), (1645400, 1009), (1646409, 746), (1647155, 657), (1647812, 915), (1648727, 758), (1649485, 538), (1650023, 671), (1650694, 712), (1651406, 674), (1652080, 619), (1652699, 656), (1653355, 692), (1654047, 929), (1654976, 683), (1655659, 809), (1656468, 660), (1657128, 651), (1657779, 710), (1658489, 362), (1658851, 763), (1659614, 857), (1660471, 673), (1661144, 525), (1661669, 766), (1662435, 617), (1663052, 750), (1663802, 935), (1664737, 896), (1665633, 464), (1666097, 661), (1666758, 486), (1667244, 614), (1667858, 662), (1668520, 716), (1669236, 729), (1669965, 1008), (1670973, 813), (1671786, 594), (1672380, 692), (1673072, 753), (1673825, 444), (1674269, 540), (1674809, 487), (1675296, 669), (1675965, 789), (1676754, 521), (1677275, 706), (1677981, 634), (1678615, 660), (1679275, 552), (1679827, 680), (1680507, 752), (1681259, 428), (1681687, 653), (1682340, 607), (1682947, 828), (1683775, 623), (1684398, 588), (1684986, 282), (1685268, 597), (1685865, 691), (1686556, 741), (1687297, 647), (1687944, 794), (1688738, 1071), (1689809, 772), (1690581, 723), (1691304, 674), (1691978, 419), (1692397, 890), (1693287, 835), (1694122, 564), (1694686, 553), (1695239, 666), (1695905, 843), (1696748, 839), (1697587, 522), (1698109, 632), (1698741, 653), (1699394, 363), (1699757, 467), (1700224, 883), (1701107, 825), (1701932, 792), (1702724, 724), (1703448, 584), (1704032, 749), (1704781, 609), (1705390, 667), (1706057, 650), (1706707, 448), (1707155, 657), (1707812, 588), (1708400, 914), (1709314, 668), (1709982, 775), (1710757, 366), (1711123, 681), (1711804, 656), (1712460, 835), (1713295, 883), (1714178, 761), (1714939, 890), (1715829, 747), (1716576, 502), (1717078, 757), (1717835, 583), (1718418, 737), (1719155, 685), (1719840, 603), (1720443, 682), (1721125, 589), (1721714, 613), (1722327, 594), (1722921, 691), (1723612, 671), (1724283, 657), (1724940, 401), (1725341, 549), (1725890, 641), (1726531, 556), (1727087, 668), (1727755, 594), (1728349, 744), (1729093, 520), (1729613, 478), (1730091, 656), (1730747, 583), (1731330, 607), (1731937, 623), (1732560, 796), (1733356, 594), (1733950, 587), (1734537, 841), (1735378, 826), (1736204, 522), (1736726, 695), (1737421, 767), (1738188, 586), (1738774, 659), (1739433, 459), (1739892, 580), (1740472, 621), (1741093, 714), (1741807, 578), (1742385, 865), (1743250, 658), (1743908, 811), (1744719, 662), (1745381, 606), (1745987, 498), (1746485, 614), (1747099, 699), (1747798, 1277), (1749075, 514), (1749589, 641), (1750230, 608), (1750838, 944), (1751782, 730), (1752512, 716), (1753228, 528), (1753756, 565), (1754321, 808), (1755129, 553), (1755682, 569), (1756251, 826), (1757077, 650), (1757727, 856), (1758583, 772), (1759355, 644), (1759999, 646), (1760645, 783), (1761428, 620), (1762048, 889), (1762937, 616), (1763553, 688), (1764241, 534), (1764775, 689), (1765464, 449), (1765913, 753), (1766666, 709), (1767375, 648), (1768023, 881), (1768904, 775), (1769679, 731), (1770410, 879), (1771289, 1007), (1772296, 815), (1773111, 586), (1773697, 839), (1774536, 662), (1775198, 483), (1775681, 443), (1776124, 692), (1776816, 774), (1777590, 406), (1777996, 951), (1778947, 462), (1779409, 718), (1780127, 844), (1780971, 697), (1781668, 769), (1782437, 626), (1783063, 730), (1783793, 665), (1784458, 667), (1785125, 546), (1785671, 566), (1786237, 410), (1786647, 586), (1787233, 437), (1787670, 740), (1788410, 815), (1789225, 740), (1789965, 700), (1790665, 621), (1791286, 568), (1791854, 808), (1792662, 406), (1793068, 518), (1793586, 736), (1794322, 513), (1794835, 841), (1795676, 2071), (1797747, 465), (1798212, 602), (1798814, 875), (1799689, 790), (1800479, 510)], [(1800989, 48), None, (1801037, 35), (1801072, 42), None, None, None, None, None, None, None, None, None, None, None, None, None, (1801114, 42), None, (1801156, 25), (1801181, 16), None, None, None, None, None, None, (1801197, 26), None, None, None, None, (1801223, 21), (1801244, 25), None, None, (1801269, 26), None, None, None, None, (1801295, 44), (1801339, 21), (1801360, 23), None, None, None, None, (1801383, 48), None, None, None, None, None, (1801431, 31), None, None, None, None, (1801462, 42), None, (1801504, 22), None, (1801526, 21), None, (1801547, 26), (1801573, 42), None, None, (1801615, 77), None, None, None, None, None, (1801692, 21), (1801713, 21), None, None, (1801734, 34), (1801768, 42), None, None, None, (1801810, 25), None, None, (1801835, 21), None, None, None, None, None, (1801856, 24), (1801880, 21), None, None, (1801901, 26), None, (1801927, 18), None, (1801945, 54), None, None, None, None, None, None, (1801999, 26), None, (1802025, 19), None, (1802044, 20), None, None, (1802064, 42), (1802106, 42), (1802148, 17), None, (1802165, 26), None, (1802191, 26), None, None, None, (1802217, 26), (1802243, 20), (1802263, 26), None, (1802289, 42), (1802331, 63), None, None, None, (1802394, 40), None, None, None, None, (1802434, 47), None, None, None, None, None, None, None, (1802481, 42), None, (1802523, 55), None, (1802578, 9), None, (1802587, 21), (1802608, 42), None, None, (1802650, 42), (1802692, 82), None, None, (1802774, 42), None, None, None, None, None, None, None, None, None, (1802816, 42), (1802858, 21), (1802879, 21), None, (1802900, 42), (1802942, 25), None, None, (1802967, 21), (1802988, 42), None, None, (1803030, 21), (1803051, 19), (1803070, 26), None, None, None, (1803096, 21), None, None, (1803117, 38), None, (1803155, 22), (1803177, 21), (1803198, 21), None, None, (1803219, 63), None, (1803282, 21), (1803303, 42), None, (1803345, 17), None, None, None, None, (1803362, 21), (1803383, 21), None, None, (1803404, 21), None, None, (1803425, 21), None, (1803446, 26), None, (1803472, 50), None, None, None, (1803522, 50), (1803572, 26), (1803598, 21), (1803619, 21), (1803640, 19), None, (1803659, 35), (1803694, 26), (1803720, 23), (1803743, 21), (1803764, 42), None, None, None, None, None, None, (1803806, 21), None, None, None, (1803827, 21), None, None, (1803848, 90), None, (1803938, 239), (1804177, 38), None, None, None, None]]  # noqa: E501
_CRC8_TABLE = [
    0x00, 0x07, 0x0e, 0x09, 0x1c, 0x1b, 0x12, 0x15,
    0x38, 0x3f, 0x36, 0x31, 0x24, 0x23, 0x2a, 0x2d,
    0x70, 0x77, 0x7e, 0x79, 0x6c, 0x6b, 0x62, 0x65,
    0x48, 0x4f, 0x46, 0x41, 0x54, 0x53, 0x5a, 0x5d,
    0xe0, 0xe7, 0xee, 0xe9, 0xfc, 0xfb, 0xf2, 0xf5,
    0xd8, 0xdf, 0xd6, 0xd1, 0xc4, 0xc3, 0xca, 0xcd,
    0x90, 0x97, 0x9e, 0x99, 0x8c, 0x8b, 0x82, 0x85,
    0xa8, 0xaf, 0xa6, 0xa1, 0xb4, 0xb3, 0xba, 0xbd,
    0xc7, 0xc0, 0xc9, 0xce, 0xdb, 0xdc, 0xd5, 0xd2,
    0xff, 0xf8, 0xf1, 0xf6, 0xe3, 0xe4, 0xed, 0xea,
    0xb7, 0xb0, 0xb9, 0xbe, 0xab, 0xac, 0xa5, 0xa2,
    0x8f, 0x88, 0x81, 0x86, 0x93, 0x94, 0x9d, 0x9a,
    0x27, 0x20, 0x29, 0x2e, 0x3b, 0x3c, 0x35, 0x32,
    0x1f, 0x18, 0x11, 0x16, 0x03, 0x04, 0x0d, 0x0a,
    0x57, 0x50, 0x59, 0x5e, 0x4b, 0x4c, 0x45, 0x42,
    0x6f, 0x68, 0x61, 0x66, 0x73, 0x74, 0x7d, 0x7a,
    0x89, 0x8e, 0x87, 0x80, 0x95, 0x92, 0x9b, 0x9c,
    0xb1, 0xb6, 0xbf, 0xb8, 0xad, 0xaa, 0xa3, 0xa4,
    0xf9, 0xfe, 0xf7, 0xf0, 0xe5, 0xe2, 0xeb, 0xec,
    0xc1, 0xc6, 0xcf, 0xc8, 0xdd, 0xda, 0xd3, 0xd4,
    0x69, 0x6e, 0x67, 0x60, 0x75, 0x72, 0x7b, 0x7c,
    0x51, 0x56, 0x5f, 0x58, 0x4d, 0x4a, 0x43, 0x44,
    0x19, 0x1e, 0x17, 0x10, 0x05, 0x02, 0x0b, 0x0c,
    0x21, 0x26, 0x2f, 0x28, 0x3d, 0x3a, 0x33, 0x34,
    0x4e, 0x49, 0x40, 0x47, 0x52, 0x55, 0x5c, 0x5b,
    0x76, 0x71, 0x78, 0x7f, 0x6a, 0x6d, 0x64, 0x63,
    0x3e, 0x39, 0x30, 0x37, 0x22, 0x25, 0x2c, 0x2b,
    0x06, 0x01, 0x08, 0x0f, 0x1a, 0x1d, 0x14, 0x13,
    0xae, 0xa9, 0xa0, 0xa7, 0xb2, 0xb5, 0xbc, 0xbb,
    0x96, 0x91, 0x98, 0x9f, 0x8a, 0x8d, 0x84, 0x83,
    0xde, 0xd9, 0xd0, 0xd7, 0xc2, 0xc5, 0xcc, 0xcb,
    0xe6, 0xe1, 0xe8, 0xef, 0xfa, 0xfd, 0xf4, 0xf3
]
# fmt: on

_IS_LEAF = 0x80
_INCLUDE_SUBDOMAINS = 0x40


try:
    from importlib.resources import open_binary

    def open_pkg_binary(path: str) -> typing.BinaryIO:
        return open_binary("hstspreload", path)


except ImportError:

    def open_pkg_binary(path: str) -> typing.BinaryIO:
        return open(
            os.path.join(os.path.dirname(os.path.abspath(__file__)), path), "rb",
        )


@functools.lru_cache(maxsize=1024)
def in_hsts_preload(host: typing.AnyStr) -> bool:
    """Determines if an IDNA-encoded host is on the HSTS preload list"""

    if isinstance(host, str):
        host = host.encode("ascii")
    labels = host.lower().split(b".")

    # Fast-branch for gTLDs that are registered to preload all sub-domains.
    if labels[-1] in _GTLD_INCLUDE_SUBDOMAINS:
        return True

    with open_pkg_binary("hstspreload.bin") as f:
        for layer, label in enumerate(labels[::-1]):
            # None of our layers are greater than 4 deep.
            if layer > 3:
                return False

            # Read the jump table for the layer and label
            jump_info = _JUMPTABLE[layer][_crc8(label)]
            if jump_info is None:
                # No entry: host is not preloaded
                return False

            # Read the set of entries for that layer and label
            f.seek(jump_info[0])
            data = bytearray(jump_info[1])
            f.readinto(data)

            for is_leaf, include_subdomains, ent_label in _iter_entries(data):
                # We found a potential leaf
                if is_leaf:
                    if ent_label == host:
                        return True
                    if include_subdomains and host.endswith(b"." + ent_label):
                        return True

                # Continue traversing as we're not at a leaf.
                elif label == ent_label:
                    break
            else:
                return False
    return False


def _iter_entries(data: bytes) -> typing.Iterable[typing.Tuple[int, int, bytes]]:
    while data:
        flags = data[0]
        size = data[1]
        label = bytes(data[2 : 2 + size])
        yield (flags & _IS_LEAF, flags & _INCLUDE_SUBDOMAINS, label)
        data = data[2 + size :]


def _crc8(value: bytes) -> int:
    # CRC8 reference implementation: https://github.com/niccokunzmann/crc8
    checksum = 0x00
    for byte in value:
        checksum = _CRC8_TABLE[checksum ^ byte]
    return checksum
